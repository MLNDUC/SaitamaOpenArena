<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>FC26 Saitama Open Arena ‚Ä¢ Bracket</title>
    <style>
        :root {
            --bg: #0b0f16;
            --panel: #121826;
            --panel2: #0f1526;
            --line: #2a3248;
            --text: #e6ebf2;
            --muted: #8a93a6;
            --a: #4da3ff;
            --b: #00ffc6;
        }

        body {
            font-family: system-ui;
            margin: 0;
            background: var(--bg);
            color: var(--text)
        }

        .wrap {
            max-width: 1100px;
            margin: 0 auto;
            padding: 16px
        }

        a {
            color: #4da3ff;
            text-decoration: none
        }

        .pill {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--panel);
            border-radius: 14px;
            padding: 12px
        }

        .card {
            background: var(--panel);
            border-radius: 14px;
            padding: 14px;
            margin: 12px 0
        }

        .muted {
            color: var(--muted);
            font-size: 13px
        }

        /* Bracket layout */
        .bracket {
            display: grid;
            grid-template-columns: 1fr 80px 1fr 80px 1fr;
            gap: 14px;
            align-items: center;
            overflow-x: auto;
            padding: 10px 0;
        }

        .col {
            min-width: 260px
        }

        .connect {
            height: 100%;
            position: relative;
            min-height: 320px
        }

        .connect:before {
            content: "";
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--line);
            transform: translateX(-50%);
            opacity: .8
        }

        .hline {
            position: absolute;
            left: 50%;
            width: 50%;
            height: 2px;
            background: var(--line);
            opacity: .8
        }

        /* Match box */
        .box {
            background: linear-gradient(180deg, #141c2f, var(--panel2));
            border: 1px solid var(--line);
            border-radius: 14px;
            padding: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, .35);
        }

        .box h3 {
            margin: 0 0 10px;
            font-size: 14px;
            color: var(--muted);
            letter-spacing: .4px
        }

        .teamrow {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            border-radius: 12px;
            background: #0f1526;
            border: 1px solid #1f2740;
            margin: 8px 0;
        }

        .left {
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 0
        }

        .logo {
            width: 26px;
            height: 26px;
            object-fit: contain;
            background: #0b0f16;
            border: 1px solid #2a3248;
            border-radius: 8px;
            padding: 3px;
            flex: 0 0 auto;
        }

        .avatar {
            font-size: 18px;
            flex: 0 0 auto
        }

        .pname {
            font-weight: 900;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 170px
        }

        .score {
            font-weight: 1000;
            font-size: 18px;
            min-width: 44px;
            text-align: right
        }

        .badge {
            font-size: 11px;
            border: 1px solid var(--line);
            color: var(--muted);
            padding: 2px 8px;
            border-radius: 999px;
            margin-left: 8px;
            white-space: nowrap
        }

        .centerTitle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 8px
        }

        .centerTitle .big {
            font-weight: 1000;
            font-size: 16px
        }

        .champ {
            font-size: 20px;
            font-weight: 1000;
            background: linear-gradient(135deg, var(--a), var(--b));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        /* Final BO3 */
        .bo3 {
            display: grid;
            gap: 10px
        }

        .game {
            background: #0f1526;
            border: 1px solid var(--line);
            border-radius: 12px;
            padding: 10px
        }

        .gameTitle {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px
        }

        .gameTitle b {
            font-size: 13px
        }

        .tag {
            font-size: 11px;
            color: var(--muted);
            border: 1px solid var(--line);
            padding: 2px 8px;
            border-radius: 999px
        }

        .gameRow {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 8px;
            border-radius: 10px;
            background: #121826
        }

        .smallScore {
            font-weight: 1000
        }

        .pending {
            opacity: .6
        }

        @media(max-width:900px) {
            .bracket {
                grid-template-columns: 1fr;
                gap: 12px
            }

            .connect,
            .hline {
                display: none
            }

            .col {
                min-width: auto
            }

            .pname {
                max-width: 220px
            }
        }
    </style>
</head>

<body>
    <div class="wrap">
        <div class="pill">
            <div><b>FC26 Saitama Open Arena</b> <span class="muted">Bracket</span></div>
            <div><a href="./index.html">Home</a> ¬∑ <a href="./table.html">Table</a></div>
        </div>

        <div class="card">
            <div class="centerTitle">
                <div>
                    <div class="big">Tournament Bracket</div>
                    <div class="muted">Playoff 1 ‚Üí Playoff 2 ‚Üí Final (BO3)</div>
                </div>
                <div id="champBox" class="muted">Ch∆∞a c√≥ champion</div>
            </div>

            <div class="bracket">
                <div class="col">
                    <div id="po1Box"></div>
                </div>
                <div class="connect">
                    <div class="hline" style="top:38%;"></div>
                    <div class="hline" style="top:62%;"></div>
                </div>
                <div class="col">
                    <div id="po2Box"></div>
                </div>
                <div class="connect">
                    <div class="hline" style="top:50%;"></div>
                </div>
                <div class="col">
                    <div id="finalBox"></div>
                </div>
            </div>
        </div>

        <div class="card">
            <b>Final BO3 ‚Äì Games</b>
            <div class="muted">Hi·ªÉn th·ªã r√µ Game 1/2/3 (k√®m logo team ƒë√£ random).</div>
            <div id="bo3"></div>
        </div>
    </div>

    <script type="module">
        import { load } from "./js/app_state.js";
        import { avatarEmoji, playerName } from "./js/ui_shared.js";
        import { recalcStandings, ensurePlayoffsGenerated } from "./js/tournament_engine.js";

        const state = load();
        if (!state?.tournament) { location.href = "./index.html"; }
        const t = state.tournament;

        recalcStandings(t);
        ensurePlayoffsGenerated(t);

        // ===== logo resolver =====
        function logoUrl(teamId) {
            if (!teamId) return "";
            return `logos/${teamId}.png`;
        }
        function safeTeamId(teamId) {
            return (teamId && typeof teamId === "string") ? teamId : null;
        }

        // Find latest log entry for a stage + participant pair
        function findLog(stage, aId, bId, labelContains = null) {
            const logs = (t.log || []).filter(e => e.stage === stage);
            // try direct id match (either direction)
            const candidates = logs.filter(e =>
                (e.aId === aId && e.bId === bId) || (e.aId === bId && e.bId === aId)
            );
            let c = candidates;
            if (labelContains) {
                c = candidates.filter(e => (e.label || "").includes(labelContains));
            }
            // pick newest
            c.sort((x, y) => (y.ts || 0) - (x.ts || 0));
            return c[0] || null;
        }

        function pNameOnly(id) {
            const p = t.players[id];
            return `${avatarEmoji(p.avatarKey)} ${p.name}`;
        }

        function teamRow(label, score, teamId, badgeHTML = "") {
            const s = (score === null || score === undefined) ? "‚Äî" : score;
            const tid = safeTeamId(teamId);
            const logo = tid ? `<img class="logo" src="${logoUrl(tid)}" alt="">` : `<span class="logo" style="display:inline-block"></span>`;
            return `
    <div class="teamrow">
      <div class="left">
        ${logo}
        <div class="avatar"></div>
        <div class="pname">${label} ${badgeHTML}</div>
      </div>
      <div class="score">${s}</div>
    </div>
  `;
        }

        function matchBox(title, aId, bId, aScore, bScore, aTeamId, bTeamId, badges = { a: "", b: "" }) {
            return `
    <div class="box">
      <h3>${title}</h3>
      ${teamRow(pNameOnly(aId), aScore, aTeamId, badges.a)}
      ${teamRow(pNameOnly(bId), bScore, bTeamId, badges.b)}
      <div class="muted" style="margin-top:8px">${(aScore !== null && bScore !== null) ? "Result saved" : "Waiting for score"}</div>
    </div>
  `;
        }

        // ===== Champion =====
        const champBox = document.getElementById("champBox");
        if (t.championId !== null) {
            champBox.innerHTML = `<span class="champ">üèÜ ${playerName(t, t.championId)}</span>`;
        } else champBox.textContent = "Ch∆∞a c√≥ champion";

        // ===== Seeds from standings =====
        const s = t.group.standings || [];
        const seed = {};
        s.forEach((p, i) => seed[p.id] = i + 1);

        // ===== Playoff 1 =====
        const po1Root = document.getElementById("po1Box");
        if (!t.playoff1) {
            po1Root.innerHTML = `<div class="muted">Playoff 1 s·∫Ω xu·∫•t hi·ªán sau khi ho√†n th√†nh v√≤ng b·∫£ng.</div>`;
        } else {
            const aId = t.playoff1.aId, bId = t.playoff1.bId;
            const aScore = t.playoff1.score?.a ?? null;
            const bScore = t.playoff1.score?.b ?? null;

            const log = findLog("playoff1", aId, bId);
            const aTeam = log?.aId === aId ? log?.aTeam : log?.bTeam;
            const bTeam = log?.aId === aId ? log?.bTeam : log?.aTeam;

            po1Root.innerHTML = matchBox(
                "PLAYOFF 1 (3rd vs 4th)",
                aId, bId,
                aScore, bScore,
                aTeam, bTeam,
                { a: `<span class="badge">#${seed[aId] || "?"}</span>`, b: `<span class="badge">#${seed[bId] || "?"}</span>` }
            );
        }

        // ===== Playoff 2 =====
        const po2Root = document.getElementById("po2Box");
        if (!t.playoff2) {
            po2Root.innerHTML = `<div class="muted">Playoff 2 s·∫Ω xu·∫•t hi·ªán sau Playoff 1.</div>`;
        } else {
            const aId = t.playoff2.aId;
            const bId = t.playoff2.bId ?? t.playoff2.seed2Id;

            if (aId === null || bId === null) {
                po2Root.innerHTML = `
      <div class="box">
        <h3>PLAYOFF 2 (Winner vs 2nd)</h3>
        <div class="muted">ƒê·ª£i k·∫øt qu·∫£ Playoff 1 ƒë·ªÉ x√°c ƒë·ªãnh ƒë·ªëi th·ªß ƒë√° v·ªõi #2.</div>
      </div>
    `;
            } else {
                const aScore = t.playoff2.score?.a ?? null;
                const bScore = t.playoff2.score?.b ?? null;

                const log = findLog("playoff2", aId, bId);
                const aTeam = log?.aId === aId ? log?.aTeam : log?.bTeam;
                const bTeam = log?.aId === aId ? log?.bTeam : log?.aTeam;

                po2Root.innerHTML = matchBox(
                    "PLAYOFF 2 (Winner vs 2nd)",
                    aId, bId,
                    aScore, bScore,
                    aTeam, bTeam,
                    { a: `<span class="badge">Winner PO1</span>`, b: `<span class="badge">#${seed[bId] || "?"}</span>` }
                );
            }
        }

        // ===== Final box (series participants) =====
        const finalRoot = document.getElementById("finalBox");
        {
            const p1Id = t.final?.p1Id ?? null;
            const p2Id = t.final?.p2Id ?? null;

            if (p1Id === null) {
                finalRoot.innerHTML = `<div class="muted">Final s·∫Ω xu·∫•t hi·ªán sau v√≤ng b·∫£ng.</div>`;
            } else if (p2Id === null) {
                finalRoot.innerHTML = `
      <div class="box">
        <h3>FINAL (BO3)</h3>
        ${teamRow(pNameOnly(p1Id), null, null, `<span class="badge">#${seed[p1Id] || "?"}</span>`)}
        <div class="teamrow pending">
          <div class="left">
            <span class="logo" style="display:inline-block"></span>
            <div class="pname">Challenger (Winner PO2) <span class="badge">TBD</span></div>
          </div>
          <div class="score">‚Äî</div>
        </div>
        <div class="muted" style="margin-top:8px">ƒê·ª£i Playoff 2 xong ƒë·ªÉ x√°c ƒë·ªãnh ƒë·ªëi th·ªß chung k·∫øt.</div>
      </div>
    `;
            } else {
                // we don't show a single team logo here because each BO3 game has its own random teams.
                // Winner already shown at top.
                finalRoot.innerHTML = `
      <div class="box">
        <h3>FINAL (BO3)</h3>
        ${teamRow(pNameOnly(p1Id), null, null, `<span class="badge">#${seed[p1Id] || "?"}</span>`)}
        ${teamRow(pNameOnly(p2Id), null, null, `<span class="badge">Challenger</span>`)}
        <div class="muted" style="margin-top:8px">
          ${t.final?.winnerId ? `Winner decided: ${playerName(t, t.final.winnerId)}` : "Playing BO3... (xem Games b√™n d∆∞·ªõi)"}
        </div>
      </div>
    `;
            }
        }

        // ===== BO3 games with logos from logs =====
        const bo3 = document.getElementById("bo3");
        {
            const p1Id = t.final?.p1Id ?? null;
            const p2Id = t.final?.p2Id ?? null;

            if (p1Id === null) {
                bo3.innerHTML = `<div class="muted">Ch∆∞a c√≥ Final.</div>`;
            } else if (p2Id === null) {
                bo3.innerHTML = `<div class="muted">ƒê·ª£i Playoff 2 xong ƒë·ªÉ v√†o Final BO3.</div>`;
            } else {
                // logs for final: label includes "Game X"
                const gLogs = [1, 2, 3].map(n => findLog("final", p1Id, p2Id, `Game ${n}`));

                const blocks = [1, 2, 3].map((n, idx) => {
                    const L = gLogs[idx];
                    const done = !!L;
                    // map teams by direction
                    const aTeam = L?.aId === p1Id ? L?.aTeam : L?.bTeam;
                    const bTeam = L?.aId === p1Id ? L?.bTeam : L?.aTeam;

                    const aScore = done ? (L.aId === p1Id ? L.aScore : L.bScore) : null;
                    const bScore = done ? (L.aId === p1Id ? L.bScore : L.aScore) : null;

                    return `
        <div class="game ${done ? "" : "pending"}">
          <div class="gameTitle">
            <b>Game ${n}</b>
            <span class="tag">${done ? "Played" : "Pending"}</span>
          </div>
          <div class="gameRow">
            <div class="left">
              ${aTeam ? `<img class="logo" src="${logoUrl(aTeam)}" alt="">` : `<span class="logo" style="display:inline-block"></span>`}
              <div>${pNameOnly(p1Id)}</div>
            </div>
            <div class="smallScore">${aScore === null ? "‚Äî" : aScore}</div>
          </div>
          <div class="gameRow" style="margin-top:6px">
            <div class="left">
              ${bTeam ? `<img class="logo" src="${logoUrl(bTeam)}" alt="">` : `<span class="logo" style="display:inline-block"></span>`}
              <div>${pNameOnly(p2Id)}</div>
            </div>
            <div class="smallScore">${bScore === null ? "‚Äî" : bScore}</div>
          </div>
        </div>
      `;
                }).join("");

                bo3.innerHTML = `<div class="bo3">${blocks}</div>`;
            }
        }
    </script>
</body>

</html>