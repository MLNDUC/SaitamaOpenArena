<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>FC26 Saitama Open Arena ‚Ä¢ Bracket</title>
    <style>
        body {
            font-family: system-ui;
            margin: 0;
            background: #0b0f16;
            color: #e6ebf2
        }

        .wrap {
            max-width: 1200px;
            margin: 0 auto;
            padding: 16px
        }

        a {
            color: #4da3ff;
            text-decoration: none
        }

        .top {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between
        }

        .pill {
            display: inline-flex;
            gap: 8px;
            align-items: center;
            background: #0f1526;
            border: 1px solid #2a3248;
            border-radius: 999px;
            padding: 8px 10px
        }

        .card {
            background: #121826;
            border-radius: 14px;
            padding: 14px;
            margin: 12px 0
        }

        .muted {
            color: #8a93a6;
            font-size: 13px
        }

        .big {
            font-size: 18px;
            font-weight: 1000
        }

        .divider {
            height: 1px;
            background: #2a3248;
            margin: 12px 0
        }

        .note {
            margin-top: 6px;
            padding: 10px;
            border-radius: 12px;
            background: #0f1526;
            border: 1px dashed #2a3248
        }

        .bracket {
            display: grid;
            grid-template-columns: 1fr 64px 1fr 64px 1fr;
            gap: 12px;
            align-items: center;
            padding-bottom: 8px
        }

        .col {
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-width: 260px
        }

        .spacer {
            height: 42px
        }

        .box {
            background: #0f1526;
            border: 1px solid #2a3248;
            border-radius: 14px;
            padding: 12px
        }

        .boxTitle {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px
        }

        .badge {
            display: inline-block;
            border: 1px solid #2a3248;
            color: #8a93a6;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 12px;
            white-space: nowrap
        }

        .teamRow {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            padding: 8px 10px;
            border-radius: 12px;
            border: 1px solid #22304a;
            background: #0b1324;
            margin-top: 8px
        }

        .left {
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 0
        }

        .logo {
            width: 34px;
            height: 34px;
            object-fit: contain;
            background: #0f1526;
            border: 1px solid #2a3248;
            border-radius: 10px;
            padding: 4px;
            flex: 0 0 auto
        }

        .name {
            font-weight: 900;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 240px
        }

        .score {
            font-weight: 1000;
            min-width: 38px;
            text-align: right
        }

        .winner {
            outline: 2px solid rgba(0, 255, 198, 0.35);
            border-color: #2a7b6a
        }

        .lines {
            position: relative;
            height: 100%;
            min-height: 380px
        }

        .lines svg {
            width: 64px;
            height: 100%;
            min-height: 380px;
            display: block
        }

        /* zoom controls */
        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 10px 0 0
        }

        .controls button {
            padding: 10px 12px;
            border-radius: 10px;
            border: 1px solid #2a3248;
            background: #0f1526;
            color: #e6ebf2;
            font-weight: 900;
            cursor: pointer
        }

        .controls button.primary {
            border: none;
            background: linear-gradient(135deg, #4da3ff, #00ffc6);
            color: #001019
        }

        .bracketViewport {
            overflow: auto;
            -webkit-overflow-scrolling: touch;
            border-radius: 14px;
            margin-top: 10px;
            background: #0b0f16;
            border: 1px solid #2a3248;
            padding: 10px;
            touch-action: pan-x pan-y;
            user-select: none
        }

        .bracketScale {
            transform-origin: 0 0;
            will-change: transform
        }

        @media (max-width:520px) {
            .bracket {
                grid-template-columns: 1fr 42px 1fr 42px 1fr
            }

            .col {
                min-width: 240px
            }

            .name {
                max-width: 180px
            }

            .lines svg {
                width: 42px
            }
        }
    </style>
</head>

<body>
    <div class="wrap">
        <div class="top">
            <div class="pill"><b>FC26 Saitama Open Arena</b><span class="muted">Bracket</span></div>
            <div class="pill"><a href="./index.html">Home</a> ¬∑ <a href="./table.html">Table</a></div>
        </div>

        <div class="card">
            <div class="big">Tournament Bracket</div>
            <div class="muted">Mobile: d√πng Fit/Zoom v√† k√©o ngang ƒë·ªÉ xem to√†n b·ªô bracket.</div>

            <div class="controls">
                <button id="btnZoomOut">‚àí</button>
                <button id="btnFit" class="primary">Fit</button>
                <button id="btnZoomIn">+</button>
                <span class="muted" id="zoomLabel" style="align-self:center">Zoom: 100%</span>
            </div>

            <div class="bracketViewport" id="viewport">
                <div class="bracketScale" id="bracketRoot"></div>
            </div>

            <div class="note muted">
                Final logo/teams l·∫•y t·ª´ log (c√≥ sau khi b·∫°n <b>Save Score</b> ·ªü Home).
            </div>
        </div>

        <div class="card">
            <div class="big">Match Log</div>
            <div class="muted">Debug ‚Äî t·∫•t c·∫£ tr·∫≠n ƒë√£ l∆∞u.</div>
            <div class="divider"></div>
            <div id="logList" class="muted"></div>
        </div>
    </div>

    <script type="module">
        import { load } from "./js/app_state.js";
        import { playerName } from "./js/ui_shared.js";

        const state = load();
        if (!state?.tournament) location.href = "./index.html";
        const t = state.tournament;

        const TEAMS = [
            { id: "real-madrid", name: "Real Madrid", u: "logos/real-madrid.png" },
            { id: "barcelona", name: "FC Barcelona", u: "logos/barcelona.png" },
            { id: "psg", name: "Paris Saint-Germain", u: "logos/psg.png" },
            { id: "liverpool", name: "Liverpool", u: "logos/liverpool.png" },
            { id: "man-city", name: "Manchester City", u: "logos/man-city.png" },
            { id: "arsenal", name: "Arsenal", u: "logos/arsenal.png" },
            { id: "bayern", name: "Bayern Munich", u: "logos/bayern.png" },
            { id: "atletico", name: "Atl√©tico Madrid", u: "logos/atletico.png" },
            { id: "newcastle", name: "Newcastle United", u: "logos/newcastle.png" },
            { id: "napoli", name: "Napoli", u: "logos/napoli.png" },
            { id: "tottenham", name: "Tottenham Hotspur", u: "logos/tottenham.png" },
            { id: "chelsea", name: "Chelsea", u: "logos/chelsea.png" },
            { id: "man-united", name: "Manchester United", u: "logos/man-united.png" },
            { id: "leverkusen", name: "Bayer Leverkusen", u: "logos/leverkusen.png" },
            { id: "spain", name: "Spain", u: "logos/spain.png" },
            { id: "france", name: "France", u: "logos/france.png" },
            { id: "argentina", name: "Argentina", u: "logos/argentina.png" },
            { id: "england", name: "England", u: "logos/england.png" },
            { id: "portugal", name: "Portugal", u: "logos/portugal.png" },
            { id: "germany", name: "Germany", u: "logos/germany.png" },
            { id: "inter", name: "Inter", u: "logos/inter.png" }
        ];
        const teamMap = new Map(TEAMS.map(x => [x.id, x]));

        const logs = Array.isArray(t.log) ? t.log : [];

        function teamLogo(teamId) { return teamId ? (teamMap.get(teamId)?.u || "") : ""; }
        function teamName(teamId) { return teamId ? (teamMap.get(teamId)?.name || teamId) : "TBD"; }
        function safeScore(x) {
            if (x === null || x === undefined) return "‚Äî";
            const n = Number(x);
            return Number.isFinite(n) ? String(n) : "‚Äî";
        }

        function lastLog(stage) {
            const arr = logs.filter(x => x.stage === stage);
            if (arr.length === 0) return null;
            arr.sort((a, b) => (b.ts || 0) - (a.ts || 0));
            return arr[0];
        }
        function logsByStage(stage) {
            const arr = logs.filter(x => x.stage === stage);
            arr.sort((a, b) => (a.ts || 0) - (b.ts || 0));
            return arr;
        }

        function rowHTML({ pid, teamId, score, isWinner }) {
            const pLabel = (pid !== null && pid !== undefined) ? playerName(t, pid) : "TBD";
            const tn = teamName(teamId);
            const logo = teamLogo(teamId);
            return `
      <div class="teamRow ${isWinner ? "winner" : ""}">
        <div class="left">
          <img class="logo" src="${logo}" alt="">
          <div style="min-width:0">
            <div class="name">${pLabel}</div>
            <div class="muted" style="font-size:12px">${tn}</div>
          </div>
        </div>
        <div class="score">${safeScore(score)}</div>
      </div>
    `;
        }

        function svgLinesHTML() {
            const svg1 = `
      <div class="lines">
        <svg viewBox="0 0 64 380" preserveAspectRatio="none">
          <path d="M 0 95 H 28 V 190 H 64" stroke="#2a3248" stroke-width="2" fill="none"/>
          <path d="M 0 285 H 28 V 190 H 64" stroke="#2a3248" stroke-width="2" fill="none"/>
        </svg>
      </div>
    `;
            const svg2 = `
      <div class="lines">
        <svg viewBox="0 0 64 380" preserveAspectRatio="none">
          <path d="M 0 190 H 28 V 190 H 64" stroke="#2a3248" stroke-width="2" fill="none"/>
        </svg>
      </div>
    `;
            return { svg1, svg2 };
        }

        function buildBracketData() {
            const po1 = t.playoff1;
            const po1Log = lastLog("playoff1");
            const po2 = t.playoff2;
            const po2Log = lastLog("playoff2");

            const finalGames = logsByStage("final").slice(0, 3);

            return {
                po1: {
                    aId: po1?.aId ?? null,
                    bId: po1?.bId ?? null,
                    aTeam: po1?.teams?.a ?? po1Log?.aTeam ?? null,
                    bTeam: po1?.teams?.b ?? po1Log?.bTeam ?? null,
                    aScore: po1?.score?.a ?? po1Log?.aScore ?? null,
                    bScore: po1?.score?.b ?? po1Log?.bScore ?? null,
                    winnerId: po1?.winnerId ?? null
                },
                po2: {
                    aId: po2?.aId ?? po2Log?.aId ?? null,
                    bId: po2?.bId ?? po2Log?.bId ?? null,
                    aTeam: po2?.teams?.a ?? po2Log?.aTeam ?? null,
                    bTeam: po2?.teams?.b ?? po2Log?.bTeam ?? null,
                    aScore: po2?.score?.a ?? po2Log?.aScore ?? null,
                    bScore: po2?.score?.b ?? po2Log?.bScore ?? null,
                    winnerId: po2?.winnerId ?? null
                },
                final: {
                    aId: t.final?.p1Id ?? null,
                    bId: t.final?.p2Id ?? null,
                    games: [1, 2, 3].map(i => {
                        const g = finalGames[i - 1];
                        return {
                            game: i,
                            aTeam: g?.aTeam ?? null,
                            bTeam: g?.bTeam ?? null,
                            aScore: g?.aScore ?? null,
                            bScore: g?.bScore ?? null
                        };
                    }),
                    winnerId: t.championId ?? null
                }
            };
        }

        function bracketHTML() {
            const d = buildBracketData();
            const { svg1, svg2 } = svgLinesHTML();

            const po1Done = (d.po1.aScore !== null && d.po1.bScore !== null);
            const po2Done = (d.po2.aScore !== null && d.po2.bScore !== null);
            const champDone = (d.final.winnerId !== null);

            const gameBoxes = d.final.games.map(g => `
      <div class="box" style="margin-top:12px">
        <div class="boxTitle">
          <div><b>Final ‚Ä¢ Game ${g.game}</b></div>
          <div class="badge">${(g.aScore !== null && g.bScore !== null) ? "Played" : "TBD"}</div>
        </div>
        ${rowHTML({ pid: d.final.aId, teamId: g.aTeam, score: g.aScore, isWinner: (champDone && d.final.winnerId === d.final.aId) })}
        ${rowHTML({ pid: d.final.bId, teamId: g.bTeam, score: g.bScore, isWinner: (champDone && d.final.winnerId === d.final.bId) })}
      </div>
    `).join("");

            const champLine = champDone
                ? `<div class="note"><b>üèÜ Champion:</b> ${playerName(t, d.final.winnerId)}</div>`
                : `<div class="note muted">Champion: TBD</div>`;

            return `
      <div class="bracket">
        <div class="col">
          <div class="box">
            <div class="boxTitle">
              <div><b>Playoff 1</b></div>
              <div class="badge">${po1Done ? "Done" : "TBD"}</div>
            </div>
            ${rowHTML({ pid: d.po1.aId, teamId: d.po1.aTeam, score: d.po1.aScore, isWinner: (d.po1.winnerId === d.po1.aId) })}
            ${rowHTML({ pid: d.po1.bId, teamId: d.po1.bTeam, score: d.po1.bScore, isWinner: (d.po1.winnerId === d.po1.bId) })}
          </div>

          <div class="spacer"></div>

          <div class="box">
            <div class="boxTitle">
              <div><b>Seed #2 (Waiting)</b></div>
              <div class="badge">Auto</div>
            </div>
            <div class="muted">Ng∆∞·ªùi h·∫°ng 2 v√†o Playoff 2 ƒë√° v·ªõi Winner Playoff 1.</div>
          </div>
        </div>

        ${svg1}

        <div class="col">
          <div class="box" style="margin-top:84px">
            <div class="boxTitle">
              <div><b>Playoff 2</b></div>
              <div class="badge">${po2Done ? "Done" : "TBD"}</div>
            </div>
            ${rowHTML({ pid: d.po2.aId, teamId: d.po2.aTeam, score: d.po2.aScore, isWinner: (d.po2.winnerId === d.po2.aId) })}
            ${rowHTML({ pid: d.po2.bId, teamId: d.po2.bTeam, score: d.po2.bScore, isWinner: (d.po2.winnerId === d.po2.bId) })}
          </div>
        </div>

        ${svg2}

        <div class="col">
          <div class="box" style="margin-top:84px">
            <div class="boxTitle">
              <div><b>Final (BO3)</b></div>
              <div class="badge">${champDone ? "Completed" : "In Progress"}</div>
            </div>
            <div class="muted">
              ${d.final.aId !== null ? playerName(t, d.final.aId) : "TBD"} vs ${d.final.bId !== null ? playerName(t, d.final.bId) : "TBD"}
            </div>
          </div>
          ${gameBoxes}
          ${champLine}
        </div>
      </div>
    `;
        }

        document.getElementById("bracketRoot").innerHTML = bracketHTML();

        // log list
        function logLine(x) {
            const when = x.ts ? new Date(x.ts).toLocaleString() : "";
            const a = (x.aId !== null && x.aId !== undefined) ? playerName(t, x.aId) : "‚Äî";
            const b = (x.bId !== null && x.bId !== undefined) ? playerName(t, x.bId) : "‚Äî";
            const sc = (x.aScore !== null && x.bScore !== null) ? `${x.aScore}-${x.bScore}` : "‚Äî";
            const ta = x.aTeam ? teamName(x.aTeam) : "TBD";
            const tb = x.bTeam ? teamName(x.bTeam) : "TBD";
            return `<div>‚Ä¢ <b>${x.stage}</b> (${x.label || ""}) ‚Äî ${a} [${ta}] vs ${b} [${tb}] : <b>${sc}</b> <span class="muted">(${when})</span></div>`;
        }
        document.getElementById("logList").innerHTML = logs.length ? logs.map(logLine).join("") : "<div class='muted'>(no logs yet)</div>";

        // zoom + fit + drag
        const viewport = document.getElementById("viewport");
        const root = document.getElementById("bracketRoot");
        const zoomLabel = document.getElementById("zoomLabel");
        let scale = 1;

        function applyScale() {
            root.style.transform = `scale(${scale})`;
            zoomLabel.textContent = `Zoom: ${Math.round(scale * 100)}%`;
            const h = root.scrollHeight * scale;
            viewport.style.minHeight = Math.max(360, Math.min(h + 20, 720)) + "px";
        }
        function fitToScreen() {
            const vw = viewport.clientWidth - 20;
            const bw = root.scrollWidth;
            if (bw > 0) {
                scale = Math.max(0.55, Math.min(1, vw / bw));
                applyScale();
                viewport.scrollLeft = 0;
                viewport.scrollTop = 0;
            }
        }

        document.getElementById("btnZoomIn").onclick = () => { scale = Math.min(1.25, scale + 0.1); applyScale(); };
        document.getElementById("btnZoomOut").onclick = () => { scale = Math.max(0.55, scale - 0.1); applyScale(); };
        document.getElementById("btnFit").onclick = fitToScreen;

        let isDown = false, startX = 0, startY = 0, sl = 0, st = 0;
        viewport.addEventListener("pointerdown", (e) => {
            isDown = true;
            viewport.setPointerCapture(e.pointerId);
            startX = e.pageX; startY = e.pageY;
            sl = viewport.scrollLeft; st = viewport.scrollTop;
        });
        viewport.addEventListener("pointermove", (e) => {
            if (!isDown) return;
            viewport.scrollLeft = sl - (e.pageX - startX);
            viewport.scrollTop = st - (e.pageY - startY);
        });
        viewport.addEventListener("pointerup", () => { isDown = false; });
        viewport.addEventListener("pointercancel", () => { isDown = false; });

        applyScale();
        setTimeout(fitToScreen, 0);
        window.addEventListener("resize", () => setTimeout(fitToScreen, 50));
    </script>
</body>

</html>