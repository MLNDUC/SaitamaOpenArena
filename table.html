<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>FC26 Saitama Open Arena • Table</title>
    <style>
        body {
            font-family: system-ui;
            margin: 0;
            background: #0b0f16;
            color: #e6ebf2
        }

        .wrap {
            max-width: 980px;
            margin: 0 auto;
            padding: 16px
        }

        a {
            color: #4da3ff;
            text-decoration: none
        }

        .pill {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #121826;
            border-radius: 14px;
            padding: 12px
        }

        .card {
            background: #121826;
            border-radius: 14px;
            padding: 14px;
            margin: 12px 0
        }

        table {
            width: 100%;
            border-collapse: collapse
        }

        th,
        td {
            padding: 10px;
            border-bottom: 1px solid #2a3248;
            text-align: left;
            font-size: 14px
        }

        input {
            width: 70px;
            padding: 8px;
            border-radius: 10px;
            border: 1px solid #2a3248;
            background: #0f1526;
            color: #e6ebf2
        }

        .muted {
            color: #8a93a6;
            font-size: 13px
        }
    </style>
</head>

<body>
    <div class="wrap">
        <div class="pill">
            <div><b>FC26 Saitama Open Arena</b> <span class="muted">Table</span></div>
            <div><a href="./index.html">Home</a> · <a href="./bracket.html">Bracket</a></div>
        </div>

        <div class="card">
            <b>Fixtures (Round 1–3)</b>
            <div class="muted">Bạn có thể nhập/sửa tỉ số tại đây. Standings sẽ tự cập nhật.</div>
            <div id="fixtures"></div>
        </div>

        <div class="card">
            <b>Standings</b>
            <div id="standings"></div>
        </div>
    </div>

    <script type="module">
        import { load, save } from "./js/app_state.js";
        import { avatarEmoji } from "./js/ui_shared.js";
        import { recalcStandings, setGroupMatchResult } from "./js/tournament_engine.js";

        const state = load();
        if (!state?.tournament) { location.href = "./index.html"; }
        const t = state.tournament;

        function pLabel(id) {
            const p = t.players[id];
            return `${avatarEmoji(p.avatarKey)} ${p.name}`;
        }

        function renderFixtures() {
            const byRound = { 1: [], 2: [], 3: [] };
            t.group.matches.forEach((m, idx) => byRound[m.round].push({ m, idx }));

            const root = document.getElementById("fixtures");
            root.innerHTML = "";

            [1, 2, 3].forEach(r => {
                const box = document.createElement("div");
                box.style.marginTop = "10px";
                box.innerHTML = `<div style="margin:8px 0"><b>Round ${r}</b></div>`;
                const table = document.createElement("table");
                table.innerHTML = `
      <thead><tr><th>Match</th><th>Score</th></tr></thead>
      <tbody></tbody>
    `;
                const tb = table.querySelector("tbody");
                byRound[r].forEach(({ m, idx }) => {
                    const tr = document.createElement("tr");
                    const a = pLabel(m.aId);
                    const b = pLabel(m.bId);
                    const sa = (m.score.a ?? "");
                    const sb = (m.score.b ?? "");
                    tr.innerHTML = `
        <td>${a} <span class="muted">vs</span> ${b}</td>
        <td>
          <input data-idx="${idx}" data-side="a" type="number" min="0" value="${sa}"> -
          <input data-idx="${idx}" data-side="b" type="number" min="0" value="${sb}">
        </td>
      `;
                    tb.appendChild(tr);
                });
                box.appendChild(table);
                root.appendChild(box);
            });

            root.querySelectorAll("input").forEach(inp => {
                inp.addEventListener("change", () => {
                    const idx = Number(inp.dataset.idx);
                    const m = t.group.matches[idx];
                    const aVal = (document.querySelector(`input[data-idx="${idx}"][data-side="a"]`).value);
                    const bVal = (document.querySelector(`input[data-idx="${idx}"][data-side="b"]`).value);
                    setGroupMatchResult(t, idx, aVal, bVal);
                    recalcStandings(t);
                    save({ tournament: t });
                    renderStandings();
                });
            });
        }

        function renderStandings() {
            recalcStandings(t);
            const s = t.group.standings;
            const root = document.getElementById("standings");
            const rows = s.map((p, i) => `
    <tr>
      <td>${i + 1}</td>
      <td>${avatarEmoji(p.avatarKey)} ${p.name}</td>
      <td>${p.stats.played}</td>
      <td>${p.stats.win}</td>
      <td>${p.stats.draw}</td>
      <td>${p.stats.loss}</td>
      <td>${p.stats.gf}</td>
      <td>${p.stats.ga}</td>
      <td>${p.stats.gd}</td>
      <td><b>${p.stats.pts}</b></td>
    </tr>
  `).join("");

            root.innerHTML = `
    <table>
      <thead>
        <tr>
          <th>#</th><th>Player</th><th>P</th><th>W</th><th>D</th><th>L</th>
          <th>GF</th><th>GA</th><th>GD</th><th>PTS</th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>
  `;
        }

        renderFixtures();
        renderStandings();
    </script>
</body>

</html>