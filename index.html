<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>FC26 Saitama Open Arena</title>
    <meta name="theme-color" content="#0b0f16">
    <link rel="manifest" href="./manifest.webmanifest">

    <style>
        body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
            margin: 0;
            background: #0b0f16;
            color: #e6ebf2
        }

        .wrap {
            max-width: 980px;
            margin: 0 auto;
            padding: 16px
        }

        .top {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between
        }

        a {
            color: #4da3ff;
            text-decoration: none
        }

        .pill {
            display: inline-flex;
            gap: 8px;
            align-items: center;
            background: #0f1526;
            border: 1px solid #2a3248;
            border-radius: 999px;
            padding: 8px 10px
        }

        .card {
            background: #121826;
            border-radius: 14px;
            padding: 14px;
            margin: 12px 0
        }

        .row {
            display: flex;
            gap: 12px;
            flex-wrap: wrap
        }

        .col {
            flex: 1;
            min-width: 260px
        }

        input,
        select,
        button {
            width: 100%;
            padding: 10px;
            border-radius: 10px;
            border: 1px solid #2a3248;
            background: #0f1526;
            color: #e6ebf2;
            font-size: 16px;
            /* ‚úÖ prevent iOS zoom */
        }

        button {
            border: none;
            background: linear-gradient(135deg, #4da3ff, #00ffc6);
            color: #001019;
            font-weight: 900;
            cursor: pointer
        }

        button:disabled {
            background: #2a3248;
            color: #8a93a6;
            cursor: not-allowed
        }

        .big {
            font-size: 18px;
            font-weight: 1000
        }

        .muted {
            color: #8a93a6;
            font-size: 13px
        }

        .divider {
            height: 1px;
            background: #2a3248;
            margin: 12px 0
        }

        .hint {
            margin-top: 8px;
            padding: 10px;
            border-radius: 12px;
            background: #0f1526;
            border: 1px dashed #2a3248
        }

        .team {
            display: flex;
            gap: 10px;
            align-items: center
        }

        .team img {
            width: 64px;
            height: 64px;
            object-fit: contain;
            background: #0f1526;
            border-radius: 12px;
            padding: 6px;
            border: 1px solid #2a3248
        }

        .grid2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px
        }
    </style>
</head>

<body>
    <div class="wrap">
        <div class="top">
            <div class="pill"><b>FC26 Saitama Open Arena</b><span class="muted">Home</span></div>
            <div class="pill"><a href="./table.html">Table</a> ¬∑ <a href="./bracket.html">Bracket</a></div>
        </div>

        <div class="card" id="setupCard">
            <div class="big">1) Setup 4 ng∆∞·ªùi ch∆°i (name only)</div>
            <div class="muted">Ch·ªâ l√†m 1 l·∫ßn m·ªói gi·∫£i. C√≥ th·ªÉ ‚ÄúReset Tournament‚Äù.</div>
            <div class="row" id="setupInputs"></div>
            <div class="row">
                <div class="col"><button id="btnCreate">Create New Tournament</button></div>
                <div class="col"><button id="btnReset" style="background:linear-gradient(135deg,#ff7a7a,#ffb86b)">Reset
                        Tournament</button></div>
            </div>
        </div>

        <div class="card" id="matchCard" style="display:none">
            <div class="big">2) Current Match</div>
            <div class="muted" id="stageLabel">-</div>

            <div class="hint">
                <div class="muted">
                    Lu·∫≠t ‚Äúƒëen t·ª± ch·ªãu‚Äù: m·ªói ng∆∞·ªùi t·ª± b·∫•m random team cho m√¨nh. Khi c·∫£ 2 ƒë√£ random xong m·ªõi ƒë∆∞·ª£c l∆∞u t·ªâ
                    s·ªë.
                </div>
                <div class="muted" style="margin-top:6px">
                    Playoff/Final: <b>kh√¥ng cho h√≤a</b> (n·∫øu h√≤a th√¨ ƒë√° pen r·ªìi nh·∫≠p k·∫øt qu·∫£ th·∫Øng thua).
                </div>
            </div>

            <div class="divider"></div>

            <div class="row">
                <div class="col">
                    <label class="muted">Player A (ƒë√∫ng ng∆∞·ªùi c·ªßa tr·∫≠n)</label>
                    <select id="selA"></select>
                </div>
                <div class="col">
                    <label class="muted">Player B (ƒë√∫ng ng∆∞·ªùi c·ªßa tr·∫≠n)</label>
                    <select id="selB"></select>
                </div>
            </div>

            <div class="row">
                <div class="col"><button id="btnRandomA">Player A Random Team</button></div>
                <div class="col"><button id="btnRandomB">Player B Random Team</button></div>
            </div>

            <div class="row">
                <div class="col"><button id="btnSaveMatch" disabled>Save Score & Advance</button></div>
                <div class="col"><button id="btnReset2" style="background:linear-gradient(135deg,#ff7a7a,#ffb86b)">Reset
                        Tournament</button></div>
            </div>

            <div class="row">
                <div class="col team">
                    <img id="logoA" alt="">
                    <div>
                        <div class="big" id="teamA">‚Äî</div>
                        <div class="muted" id="playerA">‚Äî</div>
                    </div>
                </div>
                <div class="col team">
                    <img id="logoB" alt="">
                    <div>
                        <div class="big" id="teamB">‚Äî</div>
                        <div class="muted" id="playerB">‚Äî</div>
                    </div>
                </div>
            </div>

            <div class="grid2">
                <div>
                    <label class="muted">Score A</label>
                    <input id="scoreA" type="number" min="0" inputmode="numeric" placeholder="0">
                </div>
                <div>
                    <label class="muted">Score B</label>
                    <input id="scoreB" type="number" min="0" inputmode="numeric" placeholder="0">
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { load, save, clearAll } from "./js/app_state.js";
        import { playerName } from "./js/ui_shared.js";
        import {
            createNewTournament, currentStage,
            setGroupMatchTeams, setGroupMatchResult,
            ensurePlayoffsGenerated, setPlayoff1Result, setPlayoff2Result,
            addFinalGame, logMatch
        } from "./js/tournament_engine.js";

        // ===== TEAMS LOCAL (21) =====
        const TEAMS = [
            { id: "real-madrid", name: "Real Madrid", u: "logos/real-madrid.png" },
            { id: "barcelona", name: "FC Barcelona", u: "logos/barcelona.png" },
            { id: "psg", name: "Paris Saint-Germain", u: "logos/psg.png" },
            { id: "liverpool", name: "Liverpool", u: "logos/liverpool.png" },
            { id: "man-city", name: "Manchester City", u: "logos/man-city.png" },
            { id: "arsenal", name: "Arsenal", u: "logos/arsenal.png" },
            { id: "bayern", name: "Bayern Munich", u: "logos/bayern.png" },
            { id: "atletico", name: "Atl√©tico Madrid", u: "logos/atletico.png" },
            { id: "newcastle", name: "Newcastle United", u: "logos/newcastle.png" },
            { id: "napoli", name: "Napoli", u: "logos/napoli.png" },
            { id: "tottenham", name: "Tottenham Hotspur", u: "logos/tottenham.png" },
            { id: "chelsea", name: "Chelsea", u: "logos/chelsea.png" },
            { id: "man-united", name: "Manchester United", u: "logos/man-united.png" },
            { id: "leverkusen", name: "Bayer Leverkusen", u: "logos/leverkusen.png" },
            { id: "spain", name: "Spain", u: "logos/spain.png" },
            { id: "france", name: "France", u: "logos/france.png" },
            { id: "argentina", name: "Argentina", u: "logos/argentina.png" },
            { id: "england", name: "England", u: "logos/england.png" },
            { id: "portugal", name: "Portugal", u: "logos/portugal.png" },
            { id: "germany", name: "Germany", u: "logos/germany.png" },
            { id: "inter", name: "Inter", u: "logos/inter.png" },
        ];
        const teamById = (id) => TEAMS.find(t => t.id === id);

        // ===== Sounds =====
        const tickSound = new Audio("sounds/tick.mp3");
        tickSound.volume = 0.7;
        tickSound.preload = "auto";

        const dongSound = new Audio("sounds/dong.mp3");
        dongSound.volume = 0.85;
        dongSound.preload = "auto";

        function playTick() { try { tickSound.currentTime = 0; tickSound.play(); } catch (e) { } }
        function playDong() { try { dongSound.currentTime = 0; dongSound.play(); } catch (e) { } }

        // ===== State =====
        let state = load();
        let tournament = state?.tournament ?? null;

        const setupCard = document.getElementById("setupCard");
        const matchCard = document.getElementById("matchCard");
        const setupInputs = document.getElementById("setupInputs");

        const selA = document.getElementById("selA");
        const selB = document.getElementById("selB");
        const stageLabel = document.getElementById("stageLabel");

        const btnCreate = document.getElementById("btnCreate");
        const btnReset = document.getElementById("btnReset");
        const btnReset2 = document.getElementById("btnReset2");
        const btnRandomA = document.getElementById("btnRandomA");
        const btnRandomB = document.getElementById("btnRandomB");
        const btnSaveMatch = document.getElementById("btnSaveMatch");

        const logoA = document.getElementById("logoA");
        const logoB = document.getElementById("logoB");
        const teamA = document.getElementById("teamA");
        const teamB = document.getElementById("teamB");
        const playerA = document.getElementById("playerA");
        const playerB = document.getElementById("playerB");
        const scoreA = document.getElementById("scoreA");
        const scoreB = document.getElementById("scoreB");

        let currentPicked = { aTeam: null, bTeam: null };

        function saveState() { save({ tournament }); }

        function showTournamentUI() {
            setupCard.style.display = "none";
            matchCard.style.display = "block";
            renderCurrentMatch();
        }
        function showSetupUI() {
            setupCard.style.display = "block";
            matchCard.style.display = "none";
        }

        function renderSetupInputs() {
            setupInputs.innerHTML = "";
            for (let i = 0; i < 4; i++) {
                const col = document.createElement("div");
                col.className = "col";
                col.innerHTML = `
        <label class="muted">Player ${i + 1} Name</label>
        <input id="pname_${i}" placeholder="Player ${i + 1}" value="">
      `;
                setupInputs.appendChild(col);
            }
        }

        function fillPlayerSelect(select, allowedIds) {
            select.innerHTML = "";
            allowedIds.forEach(id => {
                const opt = document.createElement("option");
                opt.value = String(id);
                opt.textContent = tournament.players[id].name;
                select.appendChild(opt);
            });
        }

        function setTeamUI(side, tId, pId) {
            const t = teamById(tId);
            const pName = tournament.players[pId].name;
            if (side === "A") {
                logoA.src = t?.u || "";
                teamA.textContent = t?.name || "‚Äî";
                playerA.textContent = pName;
            } else {
                logoB.src = t?.u || "";
                teamB.textContent = t?.name || "‚Äî";
                playerB.textContent = pName;
            }
        }

        function getAssignedTeams(cur) {
            if (cur.stage === "group") {
                const m = tournament.group.matches[cur.matchIndex];
                if (m.teams.a && m.teams.b) return { aTeam: m.teams.a, bTeam: m.teams.b };
            }
            if (cur.stage === "playoff1") {
                const p = tournament.playoff1;
                if (p?.teams?.a && p?.teams?.b) return { aTeam: p.teams.a, bTeam: p.teams.b };
            }
            if (cur.stage === "playoff2") {
                const p = tournament.playoff2;
                if (p?.teams?.a && p?.teams?.b) return { aTeam: p.teams.a, bTeam: p.teams.b };
            }
            return null; // final per-game, from currentPicked only
        }

        function randomOneTeam(excludeTeamId = null) {
            let t = TEAMS[(Math.random() * TEAMS.length) | 0];
            while (excludeTeamId && t.id === excludeTeamId) {
                t = TEAMS[(Math.random() * TEAMS.length) | 0];
            }
            return t;
        }

        async function spinWithSound(onFrame, onDone) {
            // iOS/Chrome audio unlock
            await Promise.allSettled([
                tickSound.play().then(() => tickSound.pause()),
                dongSound.play().then(() => dongSound.pause()),
            ]).catch(() => { });

            const totalTime = 3300;
            const startDelay = 45;
            const endDelay = 700;
            const suspenseHoldMs = 650;

            const startTime = performance.now();

            function loop(now) {
                const p = Math.min((now - startTime) / totalTime, 1);
                const ease = p * p * p; // g·∫Øt
                const delay = startDelay + (endDelay - startDelay) * ease;

                onFrame();
                playTick();

                if (p < 1) {
                    setTimeout(() => requestAnimationFrame(loop), delay);
                } else {
                    setTimeout(() => {
                        onDone();
                        playDong();
                    }, suspenseHoldMs);
                }
            }
            requestAnimationFrame(loop);
        }

        function maybeEnableSave() {
            if (currentPicked.aTeam && currentPicked.bTeam) {
                btnSaveMatch.disabled = false;
            }
        }

        function renderCurrentMatch() {
            const cur = currentStage(tournament);
            stageLabel.textContent = cur.label;

            // remove old restart button if exists
            const oldRestart = document.getElementById("btnRestart");
            if (oldRestart) oldRestart.remove();

            if (cur.stage === "done") {
                selA.innerHTML = "";
                selB.innerHTML = "";
                btnRandomA.disabled = true;
                btnRandomB.disabled = true;
                btnSaveMatch.disabled = true;

                logoA.src = "";
                logoB.src = "";
                teamA.textContent = "Tournament Completed";
                teamB.textContent = "";
                scoreA.value = "";
                scoreB.value = "";

                playerA.textContent = tournament.championId !== null
                    ? `üèÜ Champion: ${playerName(tournament, tournament.championId)}`
                    : "üèÅ Completed";
                playerB.textContent = "";

                // always show start new
                const restartBtn = document.createElement("button");
                restartBtn.id = "btnRestart";
                restartBtn.textContent = "Start New Tournament";
                restartBtn.style.marginTop = "12px";
                restartBtn.style.background = "linear-gradient(135deg,#ffcc00,#ff8800)";
                restartBtn.onclick = () => {
                    if (!confirm("Start new tournament? (x√≥a to√†n b·ªô d·ªØ li·ªáu gi·∫£i)")) return;
                    clearAll();
                    location.reload();
                };
                matchCard.appendChild(restartBtn);
                return;
            }

            fillPlayerSelect(selA, [cur.aId]);
            fillPlayerSelect(selB, [cur.bId]);

            scoreA.value = "";
            scoreB.value = "";
            btnSaveMatch.disabled = true;
            currentPicked = { aTeam: null, bTeam: null };

            btnRandomA.disabled = false;
            btnRandomB.disabled = false;

            const assigned = getAssignedTeams(cur);
            if (assigned) {
                currentPicked.aTeam = assigned.aTeam;
                currentPicked.bTeam = assigned.bTeam;
                setTeamUI("A", assigned.aTeam, cur.aId);
                setTeamUI("B", assigned.bTeam, cur.bId);

                btnRandomA.disabled = true;
                btnRandomB.disabled = true;
                btnSaveMatch.disabled = false;
                return;
            }

            // blank
            logoA.src = ""; logoB.src = "";
            teamA.textContent = "‚Äî"; teamB.textContent = "‚Äî";
            playerA.textContent = tournament.players[cur.aId].name;
            playerB.textContent = tournament.players[cur.bId].name;
        }

        btnRandomA.addEventListener("click", async () => {
            const cur = currentStage(tournament);
            if (cur.stage === "done") return;

            btnRandomA.disabled = true;
            btnSaveMatch.disabled = true;

            let lastA = null;

            await spinWithSound(
                () => {
                    const ta = randomOneTeam(currentPicked.bTeam);
                    lastA = ta;
                    setTeamUI("A", ta.id, cur.aId);
                },
                () => {
                    currentPicked.aTeam = lastA.id;

                    // persist for group/playoffs only
                    if (cur.stage === "group") {
                        tournament.group.matches[cur.matchIndex].teams.a = currentPicked.aTeam;
                    } else if (cur.stage === "playoff1") {
                        tournament.playoff1.teams.a = currentPicked.aTeam;
                    } else if (cur.stage === "playoff2") {
                        tournament.playoff2.teams.a = currentPicked.aTeam;
                    }

                    saveState();
                    maybeEnableSave();
                }
            );
        });

        btnRandomB.addEventListener("click", async () => {
            const cur = currentStage(tournament);
            if (cur.stage === "done") return;

            btnRandomB.disabled = true;
            btnSaveMatch.disabled = true;

            let lastB = null;

            await spinWithSound(
                () => {
                    const tb = randomOneTeam(currentPicked.aTeam);
                    lastB = tb;
                    setTeamUI("B", tb.id, cur.bId);
                },
                () => {
                    currentPicked.bTeam = lastB.id;

                    if (cur.stage === "group") {
                        tournament.group.matches[cur.matchIndex].teams.b = currentPicked.bTeam;
                    } else if (cur.stage === "playoff1") {
                        tournament.playoff1.teams.b = currentPicked.bTeam;
                    } else if (cur.stage === "playoff2") {
                        tournament.playoff2.teams.b = currentPicked.bTeam;
                    }

                    saveState();
                    maybeEnableSave();
                }
            );
        });

        btnSaveMatch.addEventListener("click", () => {
            const cur = currentStage(tournament);

            if (!currentPicked.aTeam || !currentPicked.bTeam) {
                alert("C·∫£ 2 ng∆∞·ªùi ph·∫£i random team xong m·ªõi ƒë∆∞·ª£c l∆∞u t·ªâ s·ªë.");
                return;
            }

            const aS = Number(scoreA.value);
            const bS = Number(scoreB.value);
            if (!Number.isFinite(aS) || !Number.isFinite(bS) || aS < 0 || bS < 0) {
                alert("Nh·∫≠p t·ªâ s·ªë h·ª£p l·ªá (>=0).");
                return;
            }

            // no draw in playoffs/final
            const mustDecide = (cur.stage === "playoff1" || cur.stage === "playoff2" || cur.stage === "final");
            if (mustDecide && aS === bS) {
                alert("Playoff/Final kh√¥ng cho h√≤a. N·∫øu h√≤a th√¨ ƒë√° pen r·ªìi nh·∫≠p k·∫øt qu·∫£ th·∫Øng thua.");
                return;
            }

            if (cur.stage === "group") {
                setGroupMatchTeams(tournament, cur.matchIndex, currentPicked.aTeam, currentPicked.bTeam);
                setGroupMatchResult(tournament, cur.matchIndex, aS, bS);

                logMatch(tournament, {
                    stage: "group", label: cur.label,
                    aId: cur.aId, bId: cur.bId,
                    aTeam: currentPicked.aTeam, bTeam: currentPicked.bTeam,
                    aScore: aS, bScore: bS
                });

                ensurePlayoffsGenerated(tournament);
            }

            if (cur.stage === "playoff1") {
                tournament.playoff1.teams.a = currentPicked.aTeam;
                tournament.playoff1.teams.b = currentPicked.bTeam;
                tournament.playoff1.score.a = aS;
                tournament.playoff1.score.b = bS;

                logMatch(tournament, {
                    stage: "playoff1", label: cur.label,
                    aId: cur.aId, bId: cur.bId,
                    aTeam: currentPicked.aTeam, bTeam: currentPicked.bTeam,
                    aScore: aS, bScore: bS
                });

                setPlayoff1Result(tournament, aS, bS);
            }

            if (cur.stage === "playoff2") {
                tournament.playoff2.teams.a = currentPicked.aTeam;
                tournament.playoff2.teams.b = currentPicked.bTeam;
                tournament.playoff2.score.a = aS;
                tournament.playoff2.score.b = bS;

                logMatch(tournament, {
                    stage: "playoff2", label: cur.label,
                    aId: cur.aId, bId: cur.bId,
                    aTeam: currentPicked.aTeam, bTeam: currentPicked.bTeam,
                    aScore: aS, bScore: bS
                });

                setPlayoff2Result(tournament, aS, bS);
            }

            if (cur.stage === "final") {
                // add game
                addFinalGame(tournament, aS, bS);

                logMatch(tournament, {
                    stage: "final", label: cur.label,
                    aId: cur.aId, bId: cur.bId,
                    aTeam: currentPicked.aTeam, bTeam: currentPicked.bTeam,
                    aScore: aS, bScore: bS
                });

                // if already got champion, announce once
                if (tournament.championId !== null) {
                    alert(`üèÜ Champion: ${playerName(tournament, tournament.championId)} (BO3 th·∫Øng 2 game)`);
                }
            }

            saveState();
            renderCurrentMatch();
        });

        function resetTournament() {
            if (!confirm("Reset tournament? (x√≥a to√†n b·ªô d·ªØ li·ªáu gi·∫£i)")) return;
            clearAll();
            tournament = null;
            showSetupUI();
            renderSetupInputs();
        }

        btnReset.addEventListener("click", resetTournament);
        btnReset2.addEventListener("click", resetTournament);

        // Setup create
        renderSetupInputs();

        btnCreate.addEventListener("click", () => {
            const players = [];
            for (let i = 0; i < 4; i++) {
                const name = document.getElementById(`pname_${i}`).value.trim() || `Player ${i + 1}`;
                players.push({ name });
            }
            tournament = createNewTournament(players);
            saveState();
            showTournamentUI();
        });

        // boot
        if (tournament) showTournamentUI();
        else showSetupUI();

        // register SW
        if ("serviceWorker" in navigator) {
            navigator.serviceWorker.register("./sw.js").catch(() => { });
        }
    </script>
</body>

</html>